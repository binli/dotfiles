#!/bin/bash
# Restore the rc and config files quickly

RCDIR=$PWD/homerc
CONFDIR=$PWD/config
UPDATE_FLAG=0

i=1 # the resource number

if [ -d $RCDIR ]; then
    RC_LIST=`ls $RCDIR`
fi
if [ -d $CONFDIR ]; then
    CONFIG_LIST=`ls $CONFDIR`
fi

for rcfile in $RC_LIST
do
    dotrc=$HOME/.$rcfile
    echo -e "$i) Try to restore the $dotrc..."
    if [ -e $dotrc -a ! -L $dotrc ]; then
        echo -e "remove $dotrc"
        mv $dotrc $dotrc.bak
    fi
    if [ ! -e $dotrc ]; then
        echo -e "Create $dotrc link now..."
        ln -s $RCDIR/$rcfile $dotrc
        if [ -e $dotrc.bak ]; then
            diff -Naur $dotrc.bak $dotrc
        fi
    else
        echo -e "Skip $dotrc settting."
    fi
    let "i+=1"
done

for conffile in $CONFIG_LIST
do
    homeconf=$HOME/.config/$conffile
    if [ -d $homeconf -a ! -L $homeconf ]; then
        rm -rf $homeconf
    fi
    if [ ! -d $homeconf ]; then
	echo -e "remove $homeconf"
        ln -s $PWD/config/$conffile $homeconf
        echo -e "Link the $conffile at ~/.config/ ..."
    fi
done

init_packages()
{
    package=""
    if [ "$1" = "purge" ]; then
        UBUNTU=`cat ubuntu_pkg.list | grep '^#' | cut -d'#' -f2`
    elif [ "$1" = "install" ]; then
        UBUNTU=`cat ubuntu_pkg.list | grep -v '^#'`
    else
	return
    fi
    for p in $UBUNTU
    do
        package="$package $p"
    done
    echo $package
    if [ "x$package" != "x" ] ; then
        if [ $UPDATE_FLAG -eq 0 ]; then
            sudo apt-get update
	    UPDATE_FLAG=1
        fi
        sudo apt-get $1 -y $package
    fi
}

init_chrome()
{
    if [ ! -e /etc/apt/sources.list.d/google-chrome.list ]; then
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv  78BD65473CB3BD13
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /tmp/google-chrome.list
        sudo mv /tmp/google-chrome.list /etc/apt/sources.list.d/
        sudo apt update
        sudo apt install -y google-chrome-stable
    fi
}

init_vim()
{
    VIM_PLUGIN=$HOME/.vim/plugin
    if [ ! -e $VIM_PLUGIN ]; then
        mkdir -p $VIM_PLUGIN
    fi
    if [ ! -e $VIM_PLUGIN/dirdiff.vim ]; then
        git clone git@github.com:will133/vim-dirdiff.git
	cp vim-dirdiff/plugin/dirdiff.vim $VIM_PLUGIN/
    fi
    if [ ! -e $VIM_PLUGIN/cscope_macros.vim ]; then
        wget http://www.vim.org/scripts/download_script.php?src_id=171 -O $VIM_PLUGIN/cscope_macros.vim
    fi
    if [ ! -e $VIM_PLUGIN/surround.vim ]; then
        wget https://github.com/tpope/vim-surround/raw/master/plugin/surround.vim -O $VIM_PLUGIN/surround.vim
    fi
}

init_packages purge
init_packages install
init_vim
init_chrome
